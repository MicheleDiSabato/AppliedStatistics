# Problem n.4
# The file traffic.txt contains hourly measurements of traffic volume on highway I-94 near Minneapolis recorded
# for 30 days. Consider a functional data analysis approach where, for each day, the measurements provided are
# considered as discrete sampling of underlying smooth functions.
# a) Perform a smoothing of each daily data through a projection over a B-spline basis with 15 basis elements of
# degree 3. Provide a plot of the smoothed data and report the first 3 coefficients obtained for Day 1.
# b) Perform a functional principal component analysis of the smoothed data obtained at point (a). Report the
# variance explained along the first 3 functional principal components, the screeplot and a plot of the first 3
# eigenfunctions.
# c) Propose a possible dimensionality reduction for the data, interpret the retained principal components and discuss
# the results.
# d) Provide a plot of the scores along the first functional principal component as a function of the day number.
# Discuss the result to further enhance the interpretation.

data <- read.table('traffic.txt', header=TRUE)
head(data)

# a) Perform a smoothing of each daily data through a projection over a B-spline basis with 15 basis elements of
# degree 3. Provide a plot of the smoothed data and report the first 3 coefficients obtained for Day 1.

abscissa <- 1:24
NT <- length(abscissa)
Xobs0 = as.matrix(data)
dim(Xobs0)

m <- 4          # spline order 
degree <- m-1    # spline degree 

nbasis <- 15

basis <- create.bspline.basis(range(abscissa), nbasis=nbasis, norder=m)
basismat <- eval.basis(abscissa, basis)

lsfit(basismat, Xobs0[1,], intercept=FALSE)$coef

Xsp0 = Xobs0
for (i in 1:dim(data)[1])
{
  Xsp0[i,] <- basismat %*% lsfit(basismat, Xobs0[i,], intercept=FALSE)$coef
  
}

plot(abscissa, Xobs0[1,])
points(abscissa, Xsp0[1,],col="blue", type="l")
for (i in 2:dim(data)[1])
{
  # x11()
  points(abscissa, Xobs0[i,])
  points(abscissa, Xsp0[i,],col="blue", type="l")
}
# graphics.off()

plot(abscissa, Xobs0[1,])
points(abscissa, Xsp0[1,],col="blue", type="l")


# b) Perform a functional principal component analysis of the smoothed data obtained at point (a). Report the
# variance explained along the first 3 functional principal components, the screeplot and a plot of the first 3
# eigenfunctions.
m <- 4          # spline order 
degree <- m-1    # spline degree 
nbasis <- 15
basis <- create.bspline.basis(range(abscissa), nbasis=nbasis, norder=m)
data.fd <- Data2fd(y = t(Xobs0),argvals = abscissa,basisobj = basis)
plot.fd(data.fd)
# first 3 cefficients
data.fd$coef[1:3,1]
pca <- pca.fd(data.fd,nharm=15,centerfns=TRUE)
# screeplot
plot(pca$values[1:15],xlab='j',ylab='Eigenvalues')
# plot(cumsum(pca$values)[1:15]/sum(pca$values),xlab='j',ylab='CPV',ylim=c(0.8,1))
# variance explained along the first 3 PC
(pca$values)[1:3]/sum(pca$values)
# first 3 eigenfunctions
par(mfrow=c(1,3))
plot(pca$harmonics[1,], col=1, ylab="PC1")
plot(pca$harmonics[2,], col=1, ylab="PC2")
plot(pca$harmonics[3,], col=1, ylab="PC3")
par(mfrow=c(1,1))
# dimensionality reduction: prendo le prime 3 autofunzioni
par(mfrow=c(1,3))
plot.pca.fd(pca, nx=100, pointplot=TRUE, harm=c(1,2,3), expand=0, cycle=FALSE)
par(mfrow=c(1,1))
plot(abscissa,pca$scores[,1],xlab="Scores FPC1",ylab="Scores FPC2",lwd=2)

































































































































































































































































































































































































































































































































































































































































































































































































































































































